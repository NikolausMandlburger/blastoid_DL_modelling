# Computational modeling of sequence encoding of chromatin accessibility in blastoid cell types
<br><br>
This repository contains the code for the deep learning based analyses of the paper <b>"The molecular determinants and evolution of timing of human blastocyst implantation"</b>,<br>
This includes preprocessing for and training of DeepSTARR type models for chromatin accessibility prediction from sequence as well as downstream application of<br> 
these models for de novo motif discovery as well as variant effect predictions of enhancer candidates across different primate species.<br>
<br>
<b>Structure:</b>
<br>
<br>
<u>src:</u><br>
Contains all scripts for performing data preprocessing (starting from ATAC pseudobulks), 
model training, motif discovery and cross species variant effect prediction.<br>
<br>
<u>res:</u><br>
Contains...<br>
- trained pTE accessibility models (keras models, weights in h5 format, structure in json format) 
    - /res/model_training/pTE/model_training/trained_models
- Final results of motif discovery
    - /res/motif_discovery/pTE_specopen_vs_mTE/modisco
    - /res/motif_discovery/pTE_open_regions/modisco<br>
- Final results of cross species variant effect prediction
    - /res/primate_sequence_variant_prediction/GCM1/predictions
    - /res/primate_sequence_variant_prediction/GRHL1/predictions
    - /res/primate_sequence_variant_prediction/TCF7L2/predictions

<br><b>Raw data and intermediary data files are not contained in the repository for space reasons</b><br>however readme.txt files distributed throughout the different directories of the repository hold information on intermediary files, how they are generated and what they are.
<br>
## Methods details

Training DeepSTARR models:<br>

The human genome (hg38) was tiled using a sliding window (bedtools makewindows; version 2.31.1; window size = 1,001 bp, step size = 50 bp) across canonical chromosomes 1-22, and tiles overlapping promoter regions ( 750 bp upstream to 250 bp downstream from transcription start sites annotated by GENCODE v28) or blacklisted regions (ENCODE; https://www.encodeproject.org/files/ENCFF356LFX/) were excluded. The normalised ATAC-Seq signal (sequencing depth normalised using total mapped reads, reads-per-million normalisation) from polar trophectoderm (pTE) and whole blastoid was calculated using bedtools genomecov (version 2.31.1) and the mean of the normalised signal over central 200bp parts of tiles was used for all downstream applications (in the following referred to as normalised coverage signal). For model training, tiles were retained if they were strongly accessible in pTE (pTE ATAC > 2 normalised coverage signal; n = 27,161, “open”), preferentially accessible in pTE (pTE ATAC > 1.7 normalised coverage signal and fold change > 2.5 over whole blastoid; n = 14,012, “pTE_specopen”), or specifically inaccessible in pTE (whole blastoid ATAC > 1 normalised coverage signal and fold change over pTE ATAC > 5; n = 2,711, “pTE_spec_closed”). In addition, inaccessible tiles (pTE ATAC < 0.2 normalised coverage signal; n = 107,966, “closed”) and tiles with intermediary accessibility (2 > pTE ATAC < 0.2 normalised coverage signal; n = 78,765, “intermediate”) were sampled. To avoid CpG content bias between accessible and inaccessible regions, CpG-rich inaccessible tiles (pTE ATAC < 0.2 normalised coverage signal, number of CpG dinucleotides between 60 and 160, “CG_rich_closed”) were also included. The rationale behind choosing the numbers of inaccessible tiles was to choose as many CpG rich closed regions as possible and then add the same number of randomly sampled negatives to have a high number of overall inaccessible tiles to enable models to learn that most genomic regions are inaccessible while avoiding that a CpG-content bias confounds the training. Finally, the DNA sequences of all selected tiles, as well as their reverse complement, were retrieved using seqinr (version 4.2.8). Tiles were grouped into folds of comparable size based on chromosome (fold01: chr1+chr22, fold02: chr2+chr21, fold03: chr3+chr20, …). For further details on preprocessing and data selection see scripts fragment2bw_cov.sh, Prepare_input_data_from_pseudobulk.sh and dataselection_pTE.Rmd.<br>
<br>
Convolutional neural network models of the DeepSTARR, architecture were trained using keras (version  2.4.3) and tensorflow (version  2.4.1) to predict the log1p transformed accessibility signal (ln(1+normalised_coverage_signal)) from one-hot-encoded, 1001 bp long input DNA sequences (A=[1,0,0,0], C=[0,1,0,0], G=[0,0,1,0], T=[0,0,0,1]). Models consist of four 1D convolutional layers (kernel sizes: [7,3,3,3], filter numbers: [256, 120, 60, 60]), whereby each convolutional layer is followed by a batch normalisation, a ReLU activation and a 1D max pooling (pool_size= 3) layer. After the convolutional stack, the intermediary output tensor is flattened and subjected to two dense layers (output dimensions: [64, 256]), each followed by a batch normalisation, ReLU activation and dropout (dropout probability = 0.4) layer. Finally, a dense layer with output dimension 1 is used to produce a single predicted accessibility value.<br>
<br>
Models were trained using an Adam optimizer with a learning rate of 0.005 using mean squared error loss. Models were trained for a maximum of 100 epochs with early stopping (patience: 5 epochs, validation metric: Spearman correlation, restore best weights: true).  Importance weighting was applied according to the class of a sample to ensure strong focus on sequences specifically open in pTE (applied weights: {‘closed’: 1, 'CG_rich_closed': 1, 'intermediate': 1, open': 6, 'pTE_spec_closed': 6, 'pTE_specopen': 60}). Eight folds of sequences were used for model training with one fold held out for validation at epoch ends and another fold held out for final testing.<br>
<br>
Feature attribution and motif discovery:<br>
DeepLIFT/SHAP (deeplift version 0.6.13.0, shap version 0.29.3) was used to generate feature attribution profiles for individual sequences (number of dinucleotide shuffled background sequences: 100). Modisco-lite (version 2.2.0) was used to perform de novo motif discovery from attribution profiles of sequences (modisco motifs -s ${SEQS} -a ${CONTRIBS} -n 50000). Motif discovery was performed on two different sets of sequences: (1) the set of all open or pTE specifically open sequences of fold06 (as described above)  (2) the set of all sequences that are differentially acessible in pTE relative to mTE (pTE ATAC signal > 1.2, minimum fold change of 2 of pTE over mTE ATAC signal) across the whole genome, excluding promotor and blacklist regions. Attribution profiling on both sequence sets was performed with model pTE_fold06_rep_1. JASPAR vertebrate non-redundant motif database11 was used to match discovered patterns to known transcription factor motifs using the -m option of the “modisco report” command. (JASPAR motifs file: https://jaspar.elixir.no/download/data/2024/CORE/JASPAR2024_CORE_vertebrates_non-redundant_pfms_meme.txt)<br>
<br>
Cross species comparative analysis:<br>
Candidate enhancers of GCM1, GRHL1 and TCF7L2 were selected as ATAC peaks in the vicinity of the three genes (+/- 150kb from candidate genes’ TSSs and before the next upstream and downstream TSSs) that showed trophectoderm specific accessibility. 
Peaks were called from ATAC reads of pTE cells (fragments.tsv format) using macs3 (version 3.0.1, macs3 callpeak -f BEDPE -t $pTE_FRAGMET_BED -g hs -n pTE_peaks_Q_0.4 -q 0.4 --keep-dup all). The q-value cutoff of macs3 was set to a very relaxed value of 0.4 to not miss any potentially interesting peaks in the downstream analysis. After peak calling, the set of peaks was restricted to the above mentioned search regions around the target genes using bedtools (version  2.27.1, bedtools intersect -a $pTE_NARROW_PEAKS -b <(echo -e "$ROI") > $pTE_PEAKS_IN_REGION). Only the peaks with a foldchange >1.7 (TE over inner cell mass) and a normalised coverage signal > 0.5 in TE were considered as candidate enhancers. 
These peak selection steps were performed using a custom python script (select_TEspec_peaks.py). For the resulting peaks, 1001 bp long windows were placed at their summits and also with slight offsets relative to summits (-30, -20, -10, 0, 10, 20 and 30 bp offset). These intervals were extended by 500 bp up and downstream, and multiple sequence alignments of the UCSC primate cons 30 conservation track were retrieved programmatically via the UCSC table browser retrieval tool. Deletions were removed from the alignment to obtain continuous DNA sequences for each species. These sequences were trimmed to a length of 1001 bp and written to fasta files together with their reverse complement versions. Sequences containing non-ACGT characters and sequences shorter than 1001 bp after deletion removal were excluded from the analysis. All sequence retrieval steps were performed using a custom python script (filtered_peaks_to_fasta_summitcentered.py). Sequence variants for each locus and each species were subjected to accessibility prediction with five, independently trained, replicate models, yielding n_reps*n_shifts=35 predictions per locus and species. Care was taken to score each sequence with a model that did not see the respective chromosome during the training process. For each locus, a boxplot was generated using seaborn (version 0.12.2) showing species on x axis and predicted accessibility on y axis. Predictions and visualisations were generated using a custom python script (make_candidate_predictions_with_window_shifts.py).

